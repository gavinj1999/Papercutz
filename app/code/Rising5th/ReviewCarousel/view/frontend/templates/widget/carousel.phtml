<?php
/** @var \Vendor\ReviewCarousel\Block\Widget\ReviewCarouselWidget $block */
$logger = \Magento\Framework\App\ObjectManager::getInstance()->get(\Psr\Log\LoggerInterface::class);
$logger->debug('Rendering widget/carousel.phtml');
$carousel = $block->getCarouselData();
$reviews = $block->getReviews();
?>
<?php if ($carousel && $reviews): ?>
    <?php
    // Import Google Fonts based on font_family
    $fontFamily = $block->escapeHtml($carousel->getFontFamily() ?: 'Arial');
    $fontFamilyUrl = str_replace(' ', '+', $fontFamily);
    ?>
    
    <link href="https://fonts.googleapis.com/css2?family=<?= $fontFamilyUrl ?>&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick.css" integrity="sha512-wR4oNhLBHf7smjy0K4oqzdWumd+r5/+6QO/vDda76MW5iug4PT7v86FoEkySIJft3XA0Ae6axhIvHrqwm793Nw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <div class="greview-carousel" style="
        background-color: <?= $block->escapeHtml($carousel->getBgColor() ?: '#FFFFFF') ?>;
        color: <?= $block->escapeHtml($carousel->getTextColor() ?: '#000000') ?>;
        font-family: '<?= $fontFamily ?>', sans-serif;
        font-size: <?= $block->escapeHtml($carousel->getFontSize() ?: 16) ?>px;"
        data-mage-init='{"Rising5th_ReviewCarousel/carousel": {}}'>
        <?php foreach ($reviews as $index => $review): ?>
             <div class="greview-item <?= $index + 1 == $carousel->getFeaturedReviewIndex() ? 'featured' : '' ?>"
                style="<?= $index + 1 == $carousel->getFeaturedReviewIndex() ? 'background-color: ' . $block->escapeHtml($carousel->getFeaturedBgColor() ?: '#FFFF00') . ';' : '' ?>">
                <div class="review-rating">
                    <?= $block->getStarHtml($review['rating']) ?>
                </div>
                <?php
                $fullText = $block->escapeHtml($review['review_text']);
                $words = preg_split('/\s+/', trim($fullText));
                $truncatedText = implode(' ', array_slice($words, 0, 30));
                $isTruncated = count($words) > 20;
                ?>
                <p class="greview-text" style="padding:10px;" data-full-text="<?= $fullText ?>">
                    <?= $truncatedText . ($isTruncated ? '...' : '') ?>
                </p>
                <a href="<?= $block->escapeHtml($review['review_link']) ?>">
                <span class="greview-author"><strong><i><?= $block->escapeHtml($review['name']) ?></i></strong></span>
                <span class="greview-date"><strong><?= $block->escapeHtml($review['published_at']) ?></strong></span>
            </a>
                </div>
        <?php endforeach; ?>
    </div>
    <style>
        .greview-carousel {
    max-width: 1200px !important;
    margin: 0 auto !important;
    padding: 20px !important;
    /* Hide until Slick initializes */
    opacity: 0 !important;
    transition: opacity 0.3s ease-in !important;
}

.greview-carousel.slick-initialized {
    opacity: 1 !important;
    /* Show after Slick initialization */
}

.greview-carousel .greview-item {
    padding: 20px !important;
    margin: 10px !important;
    border: 1px solid #ccc !important;
    border-radius: 5px !important;
    min-height: 200px !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: space-between !important;
}

.greview-carousel .greview-item.featured {
   /*border: 2px solid #000 !important;*/
}

.greview-carousel .greview-rating {
    margin-bottom: 10px !important;
}

.greview-carousel .review-star {
    display: inline-block !important;
    margin-right: 5px !important;
    font-family: Arial, sans-serif !important;
}

.greview-carousel .review-star.full::before {
    content: '★' !important;
    color: #FF0000 !important;
    font-size: 20px !important;
}

.greview-carousel .review-star.half::before {
    content: '★' !important;
    color: #FF0000 !important;
    font-size: 20px !important;
    clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%) !important;
}

.greview-carousel .review-star.empty::before {
    content: '☆' !important;
    color: #FF0000 !important;
    font-size: 20px !important;
}

.greview-carousel .greview-text {
    margin: 10px 0 !important;
    flex-grow: 1 !important;
}

.greview-carousel .greview-author {
    font-weight: bold !important;
}

.greview-carousel .greview-date {
    font-style: italic !important;
    font-size: 0.9em !important;
}

.slick-prev,
.slick-next {
    font-size: 24px !important;
    color: #333 !important;
    z-index: 1 !important;
}

.slick-prev {
    left: -30px !important;
}

.slick-next {
    right: -30px !important;
}

.greview-carousel .review-star.full::before {
    content: '★' !important;
    color: <?= $block->escapeHtml($carousel->getStarColor() ?: '#FF0000') ?> !important;
    font-size: <?= $block->escapeHtml($carousel->getStarSize() ?: 20) ?>px !important;
}

.greview-carousel .review-star.half::before {
    content: '★' !important;
    color: <?= $block->escapeHtml($carousel->getStarColor() ?: '#FF0000') ?> !important;
    font-size: <?= $block->escapeHtml($carousel->getStarSize() ?: 20) ?>px !important;
    clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%) !important;
}

.greview-carousel .review-star.empty::before {
    content: '☆' !important;
    color: <?= $block->escapeHtml($carousel->getStarColor() ?: '#FF0000') ?> !important;
    font-size: <?= $block->escapeHtml($carousel->getStarSize() ?: 20) ?>px !important;
}
    </style>
<?php else: ?>
    <p>No reviews or carousel configuration found.</p>
<?php endif; ?>